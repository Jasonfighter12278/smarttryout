<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>Smartschool Dashboard ‚Äî Homepage</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --brand:#a61b1b;
  --bg:#7a1f1f;
  --panel:#5e1414;
  --muted:#ffd9d9;
  --line:rgba(255,255,255,0.06);
  --accent:#e24c4c;
  --radius:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:#fff;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.3;
}

/* ===== TOP NAV ===== */
.navbar{
  background:var(--brand);
  color:#fff;
  padding:10px 16px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  position:sticky;top:0;z-index:400;
}
.nav-left{display:flex;align-items:center;gap:12px}
.profile-img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.12)}
.profile-name{font-weight:700}
.nav-right{display:flex;align-items:center;gap:8px}
.nav-item{position:relative;cursor:pointer;padding:6px 10px;border-radius:6px;user-select:none}
.nav-item > span{font-weight:600}
.nav-item:hover{background:rgba(255,255,255,.06)}
.logout-btn{font-size:18px;cursor:pointer;padding:6px 8px;border-radius:6px}

/* Dropdowns (base) */
.dropdown-menu{display:none;position:absolute;top:calc(100% + 8px);left:0;background:var(--panel);color:#fff;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;z-index:500;padding:8px}
.dropdown-menu.open{display:block}
.dropdown-menu a,.dropdown-menu button{display:block;width:100%;text-align:left;padding:8px 12px;color:#fff;text-decoration:none;background:none;border:none;cursor:pointer}
.dropdown-menu a:hover,.dropdown-menu button:hover{background:rgba(255,255,255,.04)}

/* Links dropdown custom */
#linksMenu{
  width:480px;
  background:var(--panel);
  border-radius:8px;
  padding:14px 18px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 18px;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
}
#linksMenu a{display:flex;align-items:center;gap:10px;color:#ddd;padding:6px 0}
#linksMenu a:hover{color:#fff}

/* small badge */
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:var(--accent);color:white;font-size:12px;position:absolute;top:-6px;right:-6px}

/* ===== LAYOUT: left / center / right ===== */
.shell{display:grid;grid-template-columns:260px 1fr 320px;gap:0;min-height:calc(100vh - 56px)}
.left-pane,.center-pane,.right-pane{padding:18px}
.left-pane{border-right:1px solid var(--line);background:transparent}
.right-pane{border-left:1px solid var(--line);background:transparent}
.center-stage{min-height:60vh}

/* LEFT: logo + search + mini KPIs */
.logo{
  width:140px;height:110px;border-radius:8px;border:2px solid rgba(255,255,255,.06);
  display:grid;place-items:center;font-weight:800;font-size:20px;color:#ffdede;margin-bottom:14px;
}
.search{display:flex;gap:8px;margin-bottom:14px}
.search input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:#fff}
.search button{padding:10px 12px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
.kpi{background:transparent;border:1px solid var(--line);padding:10px;border-radius:8px;margin-bottom:10px}
.small{font-size:13px;color:#ffdede;opacity:.95}

/* CENTER: clock + iframe + content */
#clock{font-size:20px;font-weight:700;text-align:center;margin-bottom:8px}
#clockTime{font-size:18px;margin-top:6px}
#welcome{font-size:18px;text-align:center;margin-bottom:8px}
#linkFrame{width:100%;height:66vh;border:1px solid var(--line);border-radius:8px;display:none;background:#fff}

/* RIGHT: calendar + agenda mini */
.calendar{background:transparent;color:#fff}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.cal-head{font-weight:700;text-align:center;color:#ffdede}
.cal-cell{aspect-ratio:1/1;display:grid;place-items:center;border-radius:8px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
.cal-cell.today{outline:2px solid #fff}

/* PAGES (agenda/messages/rooster/notifs) */
.page{display:none;padding:18px}
.page.active{display:block}
.card{background:transparent;border:1px solid var(--line);padding:14px;border-radius:10px;margin-bottom:12px}
.agenda-list{display:grid;gap:8px}
.agenda-item{padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
.timetable{display:grid;grid-template-columns:120px repeat(5,1fr);border:1px solid var(--line);border-radius:10px;overflow:visible}
.timetable .col-header{padding:12px;text-align:center;background:rgba(0,0,0,.08);font-weight:700;border-right:1px solid var(--line)}
.timetable .time-cell{padding:12px;border-right:1px solid var(--line);background:rgba(0,0,0,.04);font-weight:700}
.timetable .slot-cell{min-height:88px;padding:10px;border-right:1px solid var(--line);background:rgba(0,0,0,.02);cursor:pointer}
.slot-inner{height:100%;border-radius:8px;padding:8px;border-left:8px solid transparent;display:flex;flex-direction:column;justify-content:center;background:rgba(255,255,255,.03)}

/* modal */
.modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal .box{background:var(--panel);padding:16px;border-radius:10px;width:380px;border:1px solid var(--line);display:flex;flex-direction:column;gap:8px}
.modal input,.modal textarea,.modal select{padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(0,0,0,.12);color:#fff}
.modal textarea{min-height:80px}

/* small helpers */
.row{display:flex;gap:10px;align-items:center}
.btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);cursor:pointer}
.btn-ghost{background:transparent;padding:8px 10px;border-radius:8px;border:1px solid var(--line);color:#fff;cursor:pointer}
.hidden{display:none!important}

/* focus */
:focus{outline:3px solid rgba(255,255,255,.08);outline-offset:2px}
</style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="nav-left">
      <img id="profilePic" class="profile-img" src="" alt="profiel">
      <div>
        <div class="profile-name" id="profileName">User</div>
        <div class="small" id="roleText">Leerling</div>
      </div>
    </div>

    <div class="nav-right">
      <div class="nav-item" onclick="showPage('home')"><span>Start</span></div>

      <div class="nav-item has-dropdown" id="gotoItem">
        <span class="goto-toggle">Ga naar ‚ñæ</span>
        <div class="dropdown-menu" id="gotoMenu">
          <a onclick="showPage('agenda'); keepDropdownOpen('gotoItem')">üìÖ Agenda</a>
          <a onclick="showPage('lessenrooster'); keepDropdownOpen('gotoItem')">üìò Lesrooster</a>
          <a onclick="showPage('messages'); keepDropdownOpen('gotoItem')">‚úâÔ∏è Berichten</a>
        </div>
      </div>

      <div class="nav-item has-dropdown" id="linksItem">
        <span class="links-toggle">Links ‚ñæ</span>
        <div class="dropdown-menu" id="linksMenu">
          <!-- two-column grid handled in CSS -->
          <a href="https://leerling.appwel.be/login" target="linkFrame">üÖ∞ Appwel</a>
          <a href="https://www.diddit.be/login?smartschoolPlatform=smg" target="linkFrame">üìñ diddit</a>
          <a href="https://redwood.e-ducate.me/login" target="linkFrame">üåê e-ducate.me</a>
          <a href="https://platform.ftrprf.be/?subdomain=smg" target="linkFrame">üîµ FTRPRF</a>
          <a href="https://myway.i-learn.be/login?smartschoolPlatform=smg" target="linkFrame">üìò i-Learn</a>
          <a href="https://platform.ididdit.be/login?smartschoolPlatform=smg" target="linkFrame">üÖ∏ iDiddit</a>
          <a href="about:blank" target="linkFrame">üîó Lernova</a>
          <a href="https://www.pelckmansportaal.be/aanmelden?returnUrl=%2Fdashboard" target="linkFrame">üÖø Pelckmans Portaal</a>
          <a href="https://api.polpo.be/auth/smartschool/callback" target="linkFrame">üÖø POLPO</a>
          <a href="https://www.scholierenkoepel.be" target="linkFrame">üè´ Scholierenkoepel</a>
          <a href="https://apps.plantyn.com/my/nl-be/bookshelf?redirectPath=%2F&redirectPlatform=sep" target="linkFrame">üí† Scoodle</a>
          <a href="https://onderwijs.hetarchief.be/projecten/uitgeklaard" target="linkFrame">‚ñ∂ Uitgeklaard</a>
          <a href="https://onderwijs.vrt.be/edubox-bib/#/educatie" target="linkFrame">VRT Leer mee</a>
        </div>
      </div>

      <div id="notifNav" class="nav-item" onclick="showPage('notifications')" style="position:relative">
        <span>Meldingen üîî</span>
        <div id="notifBadge" class="badge hidden" title="meldingen">0</div>
      </div>

      <div class="nav-item has-dropdown" id="userSwitch">
        <span class="user-toggle">Account ‚ñæ</span>
        <div class="dropdown-menu" id="userMenu"></div>
      </div>

      <div class="nav-item" title="Afmelden"><span id="logoutBtn" class="logout-btn" onclick="logout()">‚éã</span></div>
    </div>
  </div>

  <!-- MAIN SHELL / PAGES -->
  <div id="home" class="shell">
    <!-- LEFT -->
    <aside class="left-pane">
      <div class="logo">de<br>Bib</div>
      <div class="search">
        <input id="leftSearch" placeholder="Zoeken...">
        <button onclick="alert('Zoeken: '+document.getElementById('leftSearch').value)">Zoeken</button>
      </div>

      <div class="kpi"><div class="small">Volgende les</div><div id="nextLesson" class="small">--</div></div>
      <div class="kpi"><div class="small">Ongelezen berichten</div><div id="unreadMsgs" class="small">0</div></div>
      <div class="kpi"><div class="small">Meldingen</div><div id="notifCountHome" class="small">0</div></div>
    </aside>

    <!-- CENTER -->
    <main class="center-pane">
      <div id="clock">
        <div id="clockDate"></div>
        <div id="clockTime" style="margin-top:6px"></div>
      </div>

      <div id="welcome" class="card">Welkom, <span id="userDisplay">User</span> üéâ</div>

      <iframe id="linkFrame" name="linkFrame"></iframe>

      <div id="recentList" class="card small">Geen recente gebeurtenissen</div>
    </main>

    <!-- RIGHT -->
    <aside class="right-pane">
      <div class="calendar card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <button class="btn-ghost" onclick="shiftMonth(-1)">‚óÄ</button>
          <div id="calTitle" style="font-weight:700"></div>
          <button class="btn-ghost" onclick="shiftMonth(1)">‚ñ∂</button>
        </div>
        <div id="calGrid" class="cal-grid" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Mini Agenda</h4>
        <div id="todayAgendaList" class="agenda-list small">Geen items voor vandaag</div>
      </div>
    </aside>
  </div>

  <!-- Agenda page -->
  <div id="agenda" class="page">
    <div class="card row" style="justify-content:space-between;align-items:center">
      <h2>Agenda</h2>
      <button class="btn" onclick="openAgendaModal()">+ Item</button>
    </div>
    <div id="agendaItems" class="agenda-list"></div>
  </div>

  <!-- Lessenrooster page -->
  <div id="lessenrooster" class="page">
    <div class="card row" style="justify-content:space-between;align-items:center">
      <div class="row"><button class="btn-ghost" onclick="prevWeek()">‚óÄ</button><div id="weekLabel" class="small">Week 0</div><button class="btn-ghost" onclick="nextWeek()">‚ñ∂</button></div>
      <div></div>
    </div>
    <div class="timetable-wrap card">
      <div id="timetable" class="timetable"></div>
    </div>
  </div>

  <!-- Messages page -->
  <div id="messages" class="page">
    <div class="card">
      <h2>Berichten</h2>
      <div id="messageList"></div>
      <div style="margin-top:10px"><button class="btn" onclick="openCompose()">Nieuw bericht</button></div>
    </div>
  </div>

  <!-- Notifications page -->
  <div id="notifications" class="page">
    <div class="card">
      <h2>Meldingen</h2>
      <div id="notifList"></div>
      <div style="margin-top:10px"><button class="btn-ghost" onclick="markAllNotifsRead()">Alles als gelezen</button></div>
    </div>
  </div>

  <!-- Modals -->
  <div id="lessonModal" class="modal" aria-hidden="true">
    <div class="box">
      <input id="modalSubject" type="text" placeholder="Vak">
      <input id="modalTeacher" type="text" placeholder="Docent">
      <input id="modalRoom" type="text" placeholder="Lokaal">
      <input id="modalColor" type="color" value="#ffd166">
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="saveLessonBtn">Opslaan</button>
        <button class="btn-ghost" onclick="closeLessonModal()">Annuleer</button>
      </div>
    </div>
  </div>

  <div id="agendaModal" class="modal" aria-hidden="true">
    <div class="box">
      <input id="agendaTitle" type="text" placeholder="Titel">
      <input id="agendaDate" type="date">
      <input id="agendaTime" type="time">
      <textarea id="agendaDesc" placeholder="Beschrijving"></textarea>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" onclick="saveAgendaItem()">Opslaan</button>
        <button class="btn-ghost" onclick="closeAgendaModal()">Annuleer</button>
      </div>
    </div>
  </div>

<script>
/* ========== STORAGE & BOOT ========== */
const ACCOUNTS={"admin":{name:"Beheerder",img:"https://static.wikia.nocookie.net/h__/images/0/09/Vorhees.jpg/revision/latest?cb=20120826172608&path-prefix=halloween",admin:true}};
let user=localStorage.getItem('loggedInUser')||'admin';
const currentUserObj=ACCOUNTS[user]||{name:user,img:'',admin:false};
document.getElementById('userDisplay').textContent=currentUserObj.name;
document.getElementById('profileName').textContent=currentUserObj.name;
document.getElementById('roleText').textContent=currentUserObj.admin?'Beheerder':'Leerling';
document.getElementById('profilePic').src=currentUserObj.img||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23444"/><text x="50" y="55" font-size="30" text-anchor="middle" fill="white">U</text></svg>';

const STORAGE={schedule:'school.schedule',messages:'school.messages',notifications:'school.notifications',agenda:'school.agenda'};

function save(key,val){localStorage.setItem(key,JSON.stringify(val))}
function load(key,def){try{return JSON.parse(localStorage.getItem(key))||def}catch(e){return def}}

// initialize storage if missing
if(!localStorage.getItem(STORAGE.schedule)) save(STORAGE.schedule,{});
if(!localStorage.getItem(STORAGE.messages)) save(STORAGE.messages,[]);
if(!localStorage.getItem(STORAGE.notifications)) save(STORAGE.notifications,[]);
if(!localStorage.getItem(STORAGE.agenda)) save(STORAGE.agenda,[]);

/* ========== CLOCK ========== */
function pad(n){return n<10?'0'+n:n;}
function fmtDate(d){return d.toLocaleDateString('nl-NL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}
function fmtTime(d){return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());}
function tick(){
  const n=new Date();
  document.getElementById('clockDate').textContent = fmtDate(n);
  document.getElementById('clockTime').textContent = fmtTime(n);
  setTimeout(tick,1000);
}
tick();

/* ========== SHOW PAGES / SHELL ========== */
function showPage(id){
  // hide pages and home shell
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.shell').forEach(s=>s.classList.add('hidden'));
  if(id==='home'){
    document.getElementById('home').classList.remove('hidden');
    // hide pages if any open
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  } else {
    // hide shell
    document.getElementById('home').classList.add('hidden');
    // show requested page
    const el=document.getElementById(id);
    if(el) el.classList.add('active');
  }
}
showPage('home');

/* ========== DROPDOWN BEHAVIOR (only toggles on toggle click) ========== */
function wireDropdown(toggleSelector, menuSelector, containerId){
  const container = document.getElementById(containerId);
  const toggle = container.querySelector(toggleSelector);
  const menu = container.querySelector(menuSelector);
  toggle.addEventListener('click', (e)=>{
    e.stopPropagation();
    const isOpen = menu.classList.contains('open');
    // close any other open menus
    document.querySelectorAll('.dropdown-menu.open').forEach(m=>m.classList.remove('open'));
    if(!isOpen) menu.classList.add('open');
    function closeHandler(ev){
      if(!container.contains(ev.target)){
        menu.classList.remove('open');
        document.removeEventListener('click',closeHandler);
      }
    }
    document.addEventListener('click', closeHandler);
  });
}
// wire the three dropdowns
wireDropdown('.links-toggle','#linksMenu','linksItem');
wireDropdown('.goto-toggle','#gotoMenu','gotoItem');
wireDropdown('.user-toggle','#userMenu','userSwitch');

/* populate user switch menu */
const userMenu=document.getElementById('userMenu');
userMenu.innerHTML=Object.keys(ACCOUNTS).map(k=>`<button onclick="switchAccount('${k}')">${ACCOUNTS[k].name}</button>`).join('');

/* ========== ACCOUNT SWITCH / LOGOUT ========== */
function switchAccount(id){ user=id; localStorage.setItem('loggedInUser',id); location.reload(); }
function logout(){ localStorage.removeItem('loggedInUser'); location.reload(); }

/* ========== AGENDA (full) ========== */
function renderAgenda(){
  const data=load(STORAGE.agenda,[]);
  const el=document.getElementById('agendaItems');
  if(!el) return;
  el.innerHTML='';
  if(data.length===0){ el.textContent='Geen items'; return; }
  data.sort((a,b)=>new Date(a.date+" "+(a.time||"00:00"))-new Date(b.date+" "+(b.time||"00:00")));
  data.forEach(it=>{
    const div=document.createElement('div');
    div.className='agenda-item';
    div.innerHTML=`<div style="font-weight:700">${it.title}</div>
                   <div class="small">${it.date} ${it.time||''}</div>
                   <div style="margin-top:6px">${it.desc||''}</div>`;
    el.appendChild(div);
  });
}
function renderMiniAgenda(){
  const data=load(STORAGE.agenda,[]);
  const el=document.getElementById('todayAgendaList');
  el.innerHTML='';
  let today=new Date().toISOString().split('T')[0];
  let any=false;
  data.forEach(it=>{
    if(it.date===today){
      const div=document.createElement('div'); div.className='agenda-item';
      div.innerHTML=`<div style="font-weight:700">${it.title}</div><div class="small">${it.time||''}</div>`;
      el.appendChild(div); any=true;
    }
  });
  if(!any) el.textContent='Geen items voor vandaag';
}
function openAgendaModal(){document.getElementById('agendaModal').style.display='flex'}
function closeAgendaModal(){document.getElementById('agendaModal').style.display='none'}
function saveAgendaItem(){
  const title=document.getElementById('agendaTitle').value;
  const date=document.getElementById('agendaDate').value;
  const time=document.getElementById('agendaTime').value;
  const desc=document.getElementById('agendaDesc').value;
  if(!title||!date) return alert('Vul titel en datum in');
  const data=load(STORAGE.agenda,[]);
  data.push({title,date,time,desc});
  save(STORAGE.agenda,data);
  closeAgendaModal();
  renderAgenda(); renderMiniAgenda();
}

/* ========== MESSAGES ========== */
function renderMessages(){
  const msgs=load(STORAGE.messages,[]);
  const el=document.getElementById('messageList');
  if(!el) return;
  el.innerHTML='';
  if(msgs.length===0){ el.textContent='Geen berichten'; return; }
  msgs.forEach(m=>{
    const div=document.createElement('div'); div.className='agenda-item';
    div.innerHTML=`<div style="font-weight:700">${m.title}</div><div class="small">${m.time||''}</div>`;
    el.appendChild(div);
  });
  updateKPI();
}
function openCompose(){
  const title=prompt('Titel bericht?'); if(!title) return;
  const time=new Date().toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
  const msgs=load(STORAGE.messages,[]); msgs.push({title,time}); save(STORAGE.messages,msgs);
  renderMessages();
}

/* ========== NOTIFICATIONS ========== */
function renderNotifications(){
  const notifs=load(STORAGE.notifications,[]);
  const el=document.getElementById('notifList');
  if(el){
    el.innerHTML='';
    if(notifs.length===0){ el.textContent='Geen meldingen'; }
    else{ notifs.forEach(n=>{ const d=document.createElement('div'); d.className='agenda-item'; d.textContent=n; el.appendChild(d); }) }
  }
  const count=load(STORAGE.notifications,[]).length;
  document.getElementById('notifCountHome').textContent=count;
  const badge=document.getElementById('notifBadge');
  badge.textContent=count;
  badge.classList.toggle('hidden',count===0);
}
function markAllNotifsRead(){ save(STORAGE.notifications,[]); renderNotifications(); }

/* ========== TIMETABLE / LESSONS ========== */
let currentWeek=0;
const days=['Ma','Di','Wo','Do','Vr'];
const hours=['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00'];
function renderTimetable(){
  const data=load(STORAGE.schedule,{});
  const el=document.getElementById('timetable');
  if(!el) return;
  el.innerHTML='';
  // header
  const headerRow=document.createElement('div'); headerRow.className='timetable';
  headerRow.innerHTML='<div class="col-header">Uur</div>'+days.map(d=>`<div class="col-header">${d}</div>`).join('');
  el.appendChild(headerRow);
  // rows
  hours.forEach(h=>{
    const row=document.createElement('div'); row.className='timetable';
    row.innerHTML=`<div class="time-cell">${h}</div>` + days.map(d=>{
      const key=`${d}-${h}`;
      const slot=data[key];
      if(slot){
        return `<div class="slot-cell" onclick="editSlot('${d}','${h}')">
                  <div class="slot-inner" style="border-left-color:${slot.color||'#ffd166'}">
                    <b>${slot.subj}</b>
                    <span class="small">${slot.teacher||''} ${slot.room||''}</span>
                  </div>
                </div>`;
      } else {
        return `<div class="slot-cell" onclick="editSlot('${d}','${h}')"><div class="slot-inner"></div></div>`;
      }
    }).join('');
    el.appendChild(row);
  });
}
let editingDay=null, editingHour=null;
function editSlot(day,hour){
  editingDay=day; editingHour=hour; document.getElementById('lessonModal').style.display='flex';
}
function closeLessonModal(){ document.getElementById('lessonModal').style.display='none'; }
document.getElementById('saveLessonBtn').onclick=function(){
  const subj=document.getElementById('modalSubject').value;
  if(!subj){ closeLessonModal(); return; }
  const teacher=document.getElementById('modalTeacher').value;
  const room=document.getElementById('modalRoom').value;
  const color=document.getElementById('modalColor').value;
  const data=load(STORAGE.schedule,{});
  data[`${editingDay}-${editingHour}`]={subj,teacher,room,color};
  save(STORAGE.schedule,data);
  closeLessonModal(); renderTimetable();
}
function prevWeek(){ currentWeek--; document.getElementById('weekLabel').textContent='Week '+currentWeek; renderTimetable(); }
function nextWeek(){ currentWeek++; document.getElementById('weekLabel').textContent='Week '+currentWeek; renderTimetable(); }

/* ========== CALENDAR (right) ========== */
let calPointer=new Date();
function renderCalendar(){
  const title=document.getElementById('calTitle');
  const grid=document.getElementById('calGrid');
  const monthFmt=new Intl.DateTimeFormat('nl-NL',{month:'long',year:'numeric'});
  title.textContent=monthFmt.format(calPointer);

  grid.innerHTML='';
  // headers ma..zo
  const weekDays=['ma','di','wo','do','vr','za','zo'];
  weekDays.forEach(d=>{ const h=document.createElement('div'); h.className='cal-head'; h.textContent=d; grid.appendChild(h); });

  const first=new Date(calPointer.getFullYear(),calPointer.getMonth(),1);
  const startIndex=(first.getDay()+6)%7; // Monday=0
  const daysInMonth=new Date(calPointer.getFullYear(),calPointer.getMonth()+1,0).getDate();

  // prev month trailing
  const prevDays=new Date(calPointer.getFullYear(),calPointer.getMonth(),0).getDate();
  for(let i=startIndex-1;i>=0;i--){ const c=document.createElement('div'); c.className='cal-cell'; c.style.opacity=.35; c.textContent=(prevDays-i); grid.appendChild(c); }

  const today=new Date(); const isThisMonth = (today.getFullYear()===calPointer.getFullYear() && today.getMonth()===calPointer.getMonth());
  for(let d=1; d<=daysInMonth; d++){
    const c=document.createElement('div'); c.className='cal-cell'; c.textContent=d;
    if(isThisMonth && d===today.getDate()) c.classList.add('today');
    grid.appendChild(c);
  }

  // fill remaining
  const cellsNeeded = 7*6;
  for(let i=grid.children.length;i<cellsNeeded;i++){ const c=document.createElement('div'); c.className='cal-cell'; c.style.opacity=.35; c.textContent=''; grid.appendChild(c); }
}
function shiftMonth(delta){ calPointer=new Date(calPointer.getFullYear(),calPointer.getMonth()+delta,1); renderCalendar(); }

/* ========== KPIS & UPDATE ========== */
function updateKPI(){
  const msgs=load(STORAGE.messages,[]);
  document.getElementById('unreadMsgs').textContent=msgs.length;
}
updateKPI();

/* ========== RENDER BOOT ========== */
renderAgenda(); renderMiniAgenda(); renderMessages(); renderNotifications(); renderTimetable(); renderCalendar();

/* ========== LINKS & IFRAME behavior ========== */
// show iframe when a link clicked (links open target="linkFrame")
document.getElementById('linksMenu').querySelectorAll('a').forEach(a=>{
  a.addEventListener('click', ()=>{
    const iframe=document.getElementById('linkFrame');
    iframe.style.display='block';
    // after click, close menu
    document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open'));
    // show home so iframe is visible in center if needed
    document.getElementById('home').classList.remove('hidden');
    // hide pages
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  });
});

/* ========== UTILITIES ========== */
// keepDropdownOpen used in goto links to keep menu open briefly (optional)
function keepDropdownOpen(id){
  // no-op or you can implement special behavior; kept for compatibility
}

/* ========== Small global event handling ========== */
// close all dropdowns when clicking outside
document.addEventListener('click', function(ev){
  document.querySelectorAll('.dropdown-menu.open').forEach(menu=>{
    // let wireDropdown handlers handle close, so only close if click outside
    // already handled in wireDropdown; this is fallback
    if(!menu.parentElement.contains(ev.target)) menu.classList.remove('open');
  });
});

// make sure Escape closes modals
document.addEventListener('keyup', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); document.querySelectorAll('.dropdown-menu').forEach(m=>m.classList.remove('open')); } });

</script>
</body>
</html>
